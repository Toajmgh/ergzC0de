title: 关于mysql查询缓存详解
author: ergz
tags:
  - Mysql
categories:
  - 数据库
date: 2016-01-01 22:48:00
---
**mysql查询缓存**  

在sql调优的过程中，发现原本很慢的一条sql（将近1分钟）在第二次运行时，瞬间就完成了（0.04sec）。 这是因为mysql自带的缓存机制，将查询结果进行缓存，如果table数据未发生变化，再次使用同一条sql进行查询时，直接从上次的查询结果缓存中读取数据，而不是重新分析、执行sql。 如果table数据发生变化，所有与之相关的缓存数据都会被释放刷新，这样就不会出现数据脏读问题。

<!--more-->

The query cache stores the text of a SELECT statement together with the corresponding result that was sent to the client. If an identical statement is received later, the server retrieves the results from the query cache rather than parsing and executing the statement again. The query cache is shared among sessions, so a result set generated by one client can be sent in response to the same query issued by another client.  

**是否使用查询缓存** 

为了避免缓存，可以在sql查询语句的字段前增加**SQL_NO_CACHE**关键字，如：  
```sql
select * from t_user;
```
```sql
select SQL_NO_CACHE * from t_user;  
```
反之，你也可以使用**SQL_CACHE**关键字，强制mysql从缓存中读取数据，如：  

```sql
select SQL_CACHE * from t_user;
```
mysql还提供了一种释放全部缓存的方法:

```sql
reset query cache;
```
**设置查询缓存**  

查看是否有查询缓存：
```sql
SHOW VARIABLES LIKE 'have_query_cache';
```
**注意**，只要数据库拥有查询缓存功能，这个VALUE就是YES，无论查询缓存是否启用，mysql默认为启用状态。mysql查询缓存可以通过两个变量来控制：**query_cache_type**和**query_cache_size**。  

**querycachetype**
```sql
SHOW VARIABLES LIKE 'query_cache_type';
```
**query_cache_type**包含三种状态：

- 0 or OFF 此时不会从缓存中读取查询数据。
- 1 or ON 表示除非声明了SELECT SQL_NO_CACHE，否则都会从缓存中读取数据。
- 2 or DEMAND 表示所有语句都会从缓存中读取，相当于所有查询语句都使用了SELECT SQL_CACHE。

通过如下命令可以设置查询缓存状态(需要管理员权限)，执行后，需要重启mysql服务才能生效。  

```sql
SET GLOBAL query_cache_type = 1;
```
但是此命令会影响所有的使用此mysql服务的client。可以通过如下命令，关闭此客户端的查询缓存状态，但是同样需要重启server后才能生效。  

```sql
SET SESSION query_cache_type = OFF;  
SHOW VARIABLES LIKE 'query_cache_type';
```
**querycachesize** 
```sql
SHOW VARIABLES LIKE 'query_cache_size';
```
**querycachesize**表示缓存大小，默认为1M。如果设置为0，则相当于:**query_cache_type=OFF**，同样可通过**SET GLOBAL**进行设置。 

```sql
SET GLOBAL query_cache_size=40000;  
```  

需要注意的是，设置的**querycachesize**，并不全是用于存储数据，还有约40KB的空间来维护查询缓存的结构。

**本文链接：[关于mysql查询缓存详解]()
欢迎转载，请注明出处！**